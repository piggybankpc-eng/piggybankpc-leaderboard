<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Control - PiggyBankPC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-box {
            background: #f7f9fc;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-box p {
            color: #333;
            font-size: 1.3em;
            font-weight: bold;
        }

        .benchmark-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .btn {
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            margin-top: 30px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-line {
            margin: 5px 0;
        }

        .log-line.error {
            color: #ff5555;
        }

        .log-line.success {
            color: #50fa7b;
        }

        .log-line.info {
            color: #8be9fd;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-card {
            background: #f7f9fc;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #50fa7b;
        }

        .result-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .download-btn {
            display: inline-block;
            padding: 15px 30px;
            background: #50fa7b;
            color: #1e1e1e;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(80, 250, 123, 0.3);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-idle {
            background: #e0e0e0;
            color: #666;
        }

        .status-running {
            background: #ffa502;
            color: white;
            animation: pulse 2s infinite;
        }

        .status-complete {
            background: #50fa7b;
            color: #1e1e1e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .gpu-price-input {
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffa502;
            display: none;
        }

        .gpu-price-input.active {
            display: block;
        }

        .gpu-price-input input {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1.1em;
            width: 200px;
            margin: 0 10px;
        }

        .gpu-price-input button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ PiggyBankPC Benchmark Control</h1>
            <p>Run benchmarks directly from your browser</p>
        </div>

        <!-- System Information Card -->
        <div class="card">
            <h2>System Information <span class="status-badge status-idle" id="status-badge">Idle</span></h2>
            <div class="system-info" id="system-info">
                <div class="info-box">
                    <h3>CPU</h3>
                    <p id="cpu-info">Detecting...</p>
                </div>
                <div class="info-box">
                    <h3>GPU</h3>
                    <p id="gpu-info">Detecting...</p>
                </div>
                <div class="info-box">
                    <h3>RAM</h3>
                    <p id="ram-info">Detecting...</p>
                </div>
                <div class="info-box">
                    <h3>GPU Price</h3>
                    <p id="gpu-price">¬£0.00</p>
                </div>
            </div>

            <!-- GPU Price Input (shown if GPU not found) -->
            <div class="gpu-price-input" id="gpu-price-input">
                <h3>‚ö†Ô∏è GPU Price Not Found</h3>
                <p>Please enter the price you paid for your GPU:</p>
                <input type="number" id="gpu-price-value" placeholder="0.00" min="0" step="0.01">
                <button onclick="saveGPUPrice()">Save Price</button>
            </div>
        </div>

        <!-- Benchmark Controls Card -->
        <div class="card">
            <h2>Benchmark Controls</h2>
            <div class="benchmark-controls">
                <button class="btn btn-primary" onclick="runBenchmark('quick')" id="btn-quick">
                    ‚ö° Quick Benchmark<br>
                    <small>(FPS only - ~15 min)</small>
                </button>
                <button class="btn btn-success" onclick="runBenchmark('full')" id="btn-full">
                    üèÜ Full Suite<br>
                    <small>(FPS+AI+CPU - ~90 min)</small>
                </button>
                <button class="btn btn-info" onclick="runBenchmark('fps')" id="btn-fps">
                    üéÆ FPS Only<br>
                    <small>(GPU test)</small>
                </button>
                <button class="btn btn-info" onclick="runBenchmark('ai')" id="btn-ai">
                    ü§ñ AI Only<br>
                    <small>(Token test)</small>
                </button>
                <button class="btn btn-info" onclick="runBenchmark('cpu')" id="btn-cpu">
                    üíª CPU Only<br>
                    <small>(Processor test)</small>
                </button>
                <button class="btn btn-warning" onclick="cleanupResults()" id="btn-cleanup">
                    üßπ Clean Up<br>
                    <small>(Remove old results)</small>
                </button>
                <button class="btn btn-danger" onclick="stopBenchmark()" id="btn-stop" disabled>
                    ‚èπÔ∏è Stop<br>
                    <small>(Cancel running test)</small>
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progress-section">
                <h3>Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar">0%</div>
                </div>
                <div class="log-output" id="log-output">
                    <div class="log-line info">Ready to start benchmark...</div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card results-section" id="results-section">
            <h2>üìä Benchmark Results</h2>
            <div id="results-container">
                <!-- Results will be populated here -->
            </div>
            <a href="#" class="download-btn" id="download-results" style="display: none;">
                ‚¨áÔ∏è Download Results (.pbr file)
            </a>
        </div>
    </div>

    <script>
        let currentBenchmark = null;
        let pollInterval = null;

        // Load system info on page load
        window.onload = function() {
            loadSystemInfo();
        };

        function loadSystemInfo() {
            fetch('/api/benchmark/system-info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('cpu-info').textContent = data.cpu.model || 'Unknown';
                        document.getElementById('gpu-info').textContent = data.gpu.model || 'Unknown';
                        document.getElementById('ram-info').textContent = data.ram.total || 'Unknown';

                        if (data.gpu_price > 0) {
                            document.getElementById('gpu-price').textContent = '¬£' + data.gpu_price.toFixed(2);
                        } else {
                            document.getElementById('gpu-price-input').classList.add('active');
                        }
                    }
                })
                .catch(error => {
                    addLog('Error loading system info: ' + error, 'error');
                });
        }

        function saveGPUPrice() {
            const price = parseFloat(document.getElementById('gpu-price-value').value);
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }

            fetch('/api/benchmark/save-gpu-price', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({price: price})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('gpu-price').textContent = '¬£' + price.toFixed(2);
                    document.getElementById('gpu-price-input').classList.remove('active');
                    addLog('GPU price saved successfully', 'success');
                } else {
                    addLog('Error saving GPU price: ' + data.error, 'error');
                }
            });
        }

        function runBenchmark(type) {
            // Disable all buttons
            disableButtons(true);
            document.getElementById('btn-stop').disabled = false;

            // Update status
            updateStatus('running');

            // Show progress section
            document.getElementById('progress-section').classList.add('active');
            clearLog();
            addLog('Starting ' + type + ' benchmark...', 'info');

            // Start benchmark
            fetch('/api/benchmark/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBenchmark = data.benchmark_id;
                    addLog('Benchmark started successfully', 'success');
                    startPolling();
                } else {
                    addLog('Error: ' + data.error, 'error');
                    disableButtons(false);
                    updateStatus('idle');
                }
            })
            .catch(error => {
                addLog('Error starting benchmark: ' + error, 'error');
                disableButtons(false);
                updateStatus('idle');
            });
        }

        function startPolling() {
            pollInterval = setInterval(() => {
                fetch('/api/benchmark/status/' + currentBenchmark)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data.progress);

                        if (data.logs) {
                            data.logs.forEach(log => addLog(log.message, log.level));
                        }

                        if (data.status === 'complete') {
                            stopPolling();
                            showResults(data.results);
                            updateStatus('complete');
                            disableButtons(false);
                        } else if (data.status === 'error') {
                            stopPolling();
                            addLog('Benchmark failed: ' + data.error, 'error');
                            updateStatus('idle');
                            disableButtons(false);
                        }
                    });
            }, 2000); // Poll every 2 seconds
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function stopBenchmark() {
            if (currentBenchmark) {
                fetch('/api/benchmark/stop/' + currentBenchmark, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        addLog('Benchmark stopped by user', 'info');
                        stopPolling();
                        updateStatus('idle');
                        disableButtons(false);
                    });
            }
        }

        function cleanupResults() {
            if (confirm('Remove all old benchmark results and logs?')) {
                fetch('/api/benchmark/cleanup', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addLog('Cleanup complete: ' + data.message, 'success');
                        } else {
                            addLog('Cleanup error: ' + data.error, 'error');
                        }
                    });
            }
        }

        function updateProgress(percent) {
            const bar = document.getElementById('progress-bar');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
        }

        function addLog(message, level = 'info') {
            const output = document.getElementById('log-output');
            const line = document.createElement('div');
            line.className = 'log-line ' + level;
            line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }

        function updateStatus(status) {
            const badge = document.getElementById('status-badge');
            badge.className = 'status-badge status-' + status;
            badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function disableButtons(disabled) {
            const buttons = ['btn-quick', 'btn-full', 'btn-fps', 'btn-ai', 'btn-cpu', 'btn-cleanup'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = disabled;
            });
            document.getElementById('btn-stop').disabled = !disabled;
        }

        function showResults(results) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            if (results.fps) {
                container.innerHTML += `
                    <div class="result-card">
                        <h4>üéÆ FPS Benchmark</h4>
                        <div class="result-value">${results.fps.average_fps} FPS</div>
                        <p>Min: ${results.fps.min_fps} | Max: ${results.fps.max_fps}</p>
                    </div>
                `;
            }

            if (results.ai) {
                container.innerHTML += `
                    <div class="result-card">
                        <h4>ü§ñ AI Benchmark</h4>
                        <div class="result-value">${results.ai.tokens_per_second} tok/s</div>
                        <p>Model: ${results.ai.model}</p>
                    </div>
                `;
            }

            if (results.cpu) {
                container.innerHTML += `
                    <div class="result-card">
                        <h4>üíª CPU Benchmark</h4>
                        <div class="result-value">${results.cpu.score}</div>
                        <p>${results.cpu.threads} threads used</p>
                    </div>
                `;
            }

            document.getElementById('results-section').classList.add('active');

            if (results.download_url) {
                const downloadBtn = document.getElementById('download-results');
                downloadBtn.href = results.download_url;
                downloadBtn.style.display = 'inline-block';
            }
        }
    </script>
</body>
</html>
